# üìã –ü—ñ–¥—Å—É–º–æ–∫ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏ —á–∞—Ç—É

## ‚úÖ –©–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

### Backend

1. **Entities**:
   - `ChatSession` - –∑–±–µ—Ä—ñ–≥–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å–µ—Å—ñ—ó —á–∞—Ç—É
   - `ChatMessage` - –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

2. **API Endpoints –¥–ª—è –∞–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—ñ** (–∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é):
   - `GET /api/chat/sessions` - –°–ø–∏—Å–æ–∫ —Å–µ—Å—ñ–π –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
   - `GET /api/chat/sessions/:id` - –î–µ—Ç–∞–ª—ñ —Å–µ—Å—ñ—ó –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏
   - `GET /api/chat/sessions/:id/messages` - –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å–µ—Å—ñ—ó (–∑ –æ–ø—Ü—ñ—î—é since)
   - `POST /api/chat/sessions/:id/messages` - –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
   - `POST /api/chat/sessions/:id/close` - –ó–∞–∫—Ä–∏—Ç–∏ —Å–µ—Å—ñ—é
   - `POST /api/chat/sessions/:id/assign` - –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
   - `GET /api/chat/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç—ñ–≤

3. **API Endpoints –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É** (–∑ API –∫–ª—é—á–µ–º):
   - `POST /api/public/chat/sessions` - –°—Ç–≤–æ—Ä–∏—Ç–∏/–æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–µ—Å—ñ—é
   - `POST /api/public/chat/sessions/:id/messages` - –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
   - `GET /api/public/chat/sessions/:id/messages?since=...` - –û—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (polling)
   - `POST /api/public/chat/notify` - Legacy endpoint –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ

4. **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö**:
   - –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å: `npm run create:chat-tables`

### Frontend (–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å)

1. **–°—Ç–æ—Ä—ñ–Ω–∫–∏**:
   - `/chat` - –°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö —á–∞—Ç—ñ–≤ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ —Ç–∞ –ø–æ—à—É–∫–æ–º
   - `/chat/[id]` - –î–µ—Ç–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ —á–∞—Ç—É –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

2. **–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å**:
   - –ü–µ—Ä–µ–≥–ª—è–¥ –∞–∫—Ç–∏–≤–Ω–∏—Ö/–∑–∞–∫—Ä–∏—Ç–∏—Ö —á–∞—Ç—ñ–≤
   - –ü–æ—à—É–∫ –ø–æ —ñ–º–µ–Ω—ñ/—Ç–µ–ª–µ—Ñ–æ–Ω—É
   - –†–µ–∞–ª-—Ç–∞–π–º –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (polling)
   - –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
   - –ó–∞–∫—Ä–∏—Ç—Ç—è —Å–µ—Å—ñ–π

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

1. `API_CHAT_FRONTEND.md` - –ü–æ–≤–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É
2. `API_CHAT_FRONTEND_EXAMPLE.md` - –ü—Ä–∏–∫–ª–∞–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ–≥–æ ChatWidget

---

## üöÄ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –ø–æ –∑–∞–ø—É—Å–∫—É

### 1. –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ –≤ –ë–î

```bash
cd admin-panel-backend
npm run create:chat-tables
```

### 2. –û–Ω–æ–≤–∏—Ç–∏ ChatWidget –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ñ

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–æ–¥ –∑ `API_CHAT_FRONTEND_EXAMPLE.md` –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∞—à–æ–≥–æ `ChatWidget.tsx`.

–û—Å–Ω–æ–≤–Ω—ñ –∑–º—ñ–Ω–∏:
- –î–æ–¥–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è `sessionId` —Ç–∞ `userSessionId` –≤ localStorage
- –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ polling –¥–ª—è –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ API endpoints –∑–∞–º—ñ—Å—Ç—å —Å—Ç–∞—Ä–æ–≥–æ `/api/telegram-notify`

### 3. –î–æ—Å—Ç—É–ø –¥–æ –∞–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—ñ

- URL: `/chat` - —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
- URL: `/chat/[id]` - –¥–µ—Ç–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ —á–∞—Ç—É

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö

### ChatSession
```typescript
{
  id: string (UUID)
  userName: string | null
  userPhone: string | null
  status: 'active' | 'closed' | 'archived'
  managerId: string | null
  userSessionId: string | null
  createdAt: Date
  updatedAt: Date
}
```

### ChatMessage
```typescript
{
  id: string (UUID)
  sessionId: string (UUID)
  sender: 'user' | 'manager'
  messageText: string
  managerId: string | null
  createdAt: Date
}
```

---

## üîÑ –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö

```
–§—Ä–æ–Ω—Ç–µ–Ω–¥ (ChatWidget)
    ‚Üì
POST /api/public/chat/sessions (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–µ—Å—ñ—ó)
    ‚Üì
–ë–î (chat_sessions, chat_messages)
    ‚Üì
Telegram (–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º)
    ‚Üì
–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å (–ø–µ—Ä–µ–≥–ª—è–¥ —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å)
    ‚Üì
POST /api/chat/sessions/:id/messages (–≤—ñ–¥–ø–æ–≤—ñ–¥—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞)
    ‚Üì
–ë–î (chat_messages)
    ‚Üì
GET /api/public/chat/sessions/:id/messages?since=... (polling)
    ‚Üì
–§—Ä–æ–Ω—Ç–µ–Ω–¥ (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI)
```

---

## üìù –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é** - `npm run create:chat-tables`
2. **–û–Ω–æ–≤–∏—Ç–∏ ChatWidget** - –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∫–æ–¥ –∑ `API_CHAT_FRONTEND_EXAMPLE.md`
3. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–æ–±–æ—Ç—É** - –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤—É —Å–µ—Å—ñ—é —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
4. **–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ API –∫–ª—é—á—ñ** - –î–æ–¥–∞—Ç–∏ –≤ `.env` –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ñ

---

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ

1. **API –∫–ª—é—á—ñ** - –í–∏–Ω–µ—Å—Ç–∏ –∑ –∫–æ–¥—É –≤ env –∑–º—ñ–Ω–Ω—ñ
2. **Polling —ñ–Ω—Ç–µ—Ä–≤–∞–ª** - –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è 2-3 —Å–µ–∫—É–Ω–¥–∏
3. **–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–µ—Å—ñ—ó** - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ localStorage –¥–ª—è persistence
4. **–û—á–∏—â–µ–Ω–Ω—è** - –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –æ—á–∏—â–∞—Ç–∏ localStorage –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Å–µ—Å—ñ—ó

